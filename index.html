<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notion ä¸­æ–‡å­—é«” & Callout Widget</title>
  
  <!-- è‡ªè¨‚å­—é«”å®šç¾© -->
  <style>
    @font-face {
      font-family: 'ChenYuluoyan-Thin-Monospaced';
      src: url('./assets/Fonts/ChenYuluoyan-Thin-Monospaced.ttf') format('truetype');
      font-weight: 100;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'cwtexq-fangsong';
      src: url('./assets/Fonts/cwtexq-fangsong-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'simfang';
      src: url('./assets/Fonts/simfang.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'STFANGSO';
      src: url('./assets/Fonts/STFANGSO.TTF') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'ToneOZ-Tsuipita-TC';
      src: url('./assets/Fonts/ToneOZ-Tsuipita-TC.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'ç‹æ±‰å®—é¡æ¥·ä½“ç¹';
      src: url('./assets/Fonts/ç‹æ±‰å®—é¡æ¥·ä½“ç¹.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'å¾®è»Ÿæ­£é»‘é«”';
      src: url('./assets/Fonts/å¾®è»Ÿæ­£é»‘é«”/msjh.ttc') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'å¾®è»Ÿæ­£é»‘é«”-Bold';
      src: url('./assets/Fonts/å¾®è»Ÿæ­£é»‘é«”/msjhbd.ttc') format('truetype');
      font-weight: 700;
      font-style: normal;
    }
    
    @font-face {
      font-family: 'å¾®è»Ÿæ­£é»‘é«”-Light';
      src: url('./assets/Fonts/å¾®è»Ÿæ­£é»‘é«”/msjhl.ttc') format('truetype');
      font-weight: 300;
      font-style: normal;
    }
  </style>
  
  <!-- Google Fontsï¼šç¹ä¸­å¯ç”¨å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;600;700&family=LXGW+WenKai+TC&display=swap" rel="stylesheet">
  
  <!-- KaTeX æ•¸å­¸å…¬å¼æ¸²æŸ“ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  
  <style>
    :root{
      --font: 'Noto Sans TC', system-ui, -apple-system, 'Segoe UI', Roboto, 'PingFang TC', 'Microsoft JhengHei', sans-serif;
      --size: 18px;
      --weight: 500;
      --text: #111111;
      --bg: transparent; /* èˆ‡ Notion èåˆ */
      --radius: 12px;
      --padding: 16px;
      --line: 1.55;
      --align: left;
      --accent: #8b5cf6; /* callout é‚Šæ¢èˆ‡åœ–ç¤ºé¡è‰² */
      --shadow: 0 0 0 rgba(0,0,0,0);
    }
    
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg);}

    /* Icon Gate æ¨£å¼ */
    .gate {
      position: relative;
      display: grid;
      place-items: center;
      height: 320px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .gate.hidden {
      display: none;
    }
    
    .gate-card {
      display: grid;
      gap: 12px;
      place-items: center;
      border: 1px dashed #ddd;
      padding: 24px;
      border-radius: 16px;
      background: color-mix(in oklab, var(--accent) 6%, #fff 94%);
      transition: all 0.3s ease;
    }
    
    .gate-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-color: var(--accent);
    }
    
    .gate-card img {
      display: block;
      max-width: 200px;
      max-height: 200px;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    
    .gate-title {
      font: 600 16px/1.4 ui-sans-serif, system-ui;
      color: #475569;
    }

    .wrap{
      font-family: var(--font);
      font-size: var(--size);
      font-weight: var(--weight);
      color: var(--text);
      border-radius: var(--radius);
      padding: var(--padding);
      line-height: var(--line);
      text-align: var(--align);
      box-shadow: var(--shadow);
      word-break: break-word;
    }

    /* æ¨¡æ“¬ Notion Callout æ¨£å¼ */
    .callout{
      display:grid;
      grid-template-columns: auto 1fr;
      gap:12px;
      align-items:flex-start;
      border:1px solid color-mix(in oklab, var(--accent) 35%, #0000 65%);
      background: color-mix(in oklab, var(--accent) 6%, var(--bg) 94%);
    }
    .callout::before{
      content: var(--icon, '\"ğŸ’¡\"');
      display:block;
      font-size: 1.2em;
      line-height:1;
      padding-top:2px;
      color: var(--accent);
    }
    .strip{ border-left: 6px solid var(--accent); }

    /* å…§å»ºæ§åˆ¶é¢æ¿ï¼ˆå¯ç”¨ &ui=0 é—œé–‰ï¼‰ */
    .panel{ position:sticky; top:0; inset-inline:0; background:#fff; border-bottom:1px solid #eee; padding:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; z-index:2 }
    .panel label{ font: 12px/1.2 ui-sans-serif, system-ui; color:#666 }
    .panel input[type="text"], .panel input[type="number"], .panel input[type="color"], .panel select{ font: 12px/1.2 ui-sans-serif, system-ui; padding:6px 8px; border:1px solid #ddd; border-radius:8px }
    .panel .spacer{ flex:1 }
    .panel .btn{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fafafa; cursor:pointer }

    /* è®“ Notion å¯ç”¨ã€ŒResize to fitã€æ™‚é«˜åº¦å‰›å¥½ */
    #content{ padding: 8px }
    .hidden{ display:none !important }
    
    /* Headingsï¼ˆæ²¿ç”¨ä½ çš„ --font/--size/--weightï¼Œå¯åœ¨ render æ™‚èª¿æ•´ size/weightï¼‰ */
    .h1 { font-size: calc(var(--size) * 1.8); font-weight: 700; letter-spacing: -0.01em; }
    .h2 { font-size: calc(var(--size) * 1.5); font-weight: 700; letter-spacing: -0.005em; }
    .h3 { font-size: calc(var(--size) * 1.25); font-weight: 700; }

    .quote { border-left: 4px solid var(--accent); padding-left: 12px; opacity: .9; }

    .ul, .ol { padding-left: 1.25em; }
    .ul li { list-style: disc; margin: 6px 0; }
    .ol li { list-style: decimal; margin: 6px 0; }

    .todo { display: grid; gap: 8px; }
    .todo-item { display: grid; grid-template-columns: 20px 1fr; align-items: start; gap: 8px; }
    .todo-item input[type="checkbox"] { margin-top: 4px; }
    .todo-item.done .todo-text { text-decoration: line-through; opacity: .6; }

    .toggle { border: 1px dashed color-mix(in oklab, var(--accent) 25%, #0000 75%); border-radius: 10px; }
    .toggle summary { cursor: pointer; padding: 8px 10px; font-weight: 600; color: var(--text); }
    .toggle .toggle-body { padding: 8px 12px 12px; opacity: .95; }

    .codewrap { background: #0b1220; color: #eaeefb; border-radius: 10px; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; overflow:auto; }
    .codewrap code { white-space: pre; display:block; line-height: 1.6; }

    /* Math ç½®ä¸­é¡¯ç¤ºï¼ˆå¯ä¾éœ€æ±‚å¾®èª¿ï¼‰ */
    .math { display:grid; place-items:center; padding: 8px; }

    /* è®“ contenteditable å…§çš„ list/todo å¥½ç·¨è¼¯ */
    [contenteditable] li, [contenteditable] .todo-item, [contenteditable] summary { outline: none; }

    /* éš±è—é¢æ¿æ™‚çš„ç„¡ç¸«åµŒå…¥æ¨£å¼ */
    .ui-hidden .panel{ display:none !important; }
    .ui-hidden #content{ padding:0 !important; background:transparent !important; }
    .ui-hidden .wrap{ padding:0 !important; box-shadow:none !important; background:transparent !important; border:none !important; }

    /* æœ‰åŠ© Notion è¨ˆç®—å…§åµŒé«˜åº¦ */
    html, body { height:auto; }
  </style>
</head>
<body>
  <!-- Icon Gateï¼ˆé»æ“Šåœ–ç¤ºé€²å…¥ç·¨è¼¯å™¨ï¼‰ -->
  <div id="gate" class="gate">
    <div class="gate-card">
      <img id="gateIcon" src="./assets/Icon/widget_icon.png" alt="Widget Icon"/>
      <div id="gateTitle" class="gate-title">é»ä¸€ä¸‹é–‹å§‹ç·¨è¼¯</div>
    </div>
  </div>

  <!-- æ–‡å­—ç·¨è¼¯å™¨ -->
  <div id="editorContainer" class="hidden">
    <div id="controls" class="panel">
      <label>æ¨¡å¼
        <select id="mode">
          <option value="plain">Paragraph</option>
          <option value="h1">Heading 1</option>
          <option value="h2">Heading 2</option>
          <option value="h3">Heading 3</option>
          <option value="todo">To-Do List</option>
          <option value="bulleted">Bulleted List</option>
          <option value="numbered">Numbered List</option>
          <option value="toggle">Toggle List</option>
          <option value="quote">Quote</option>
          <option value="callout">Callout</option>
          <option value="strip">Left Strip</option>
          <option value="code">Code Block</option>
          <option value="math">Math (KaTeX)</option>
        </select>
      </label>
      <button class="btn" id="insertExample">æ’å…¥ç¯„ä¾‹</button>
      <label>å­—é«”
        <select id="font">
          <option value="Noto Sans TC">Noto Sans TC</option>
          <option value="Noto Serif TC">Noto Serif TC</option>
          <option value="LXGW WenKai TC">LXGW WenKai TCï¼ˆéœé¶©æ–‡æ¥·ï¼‰</option>
          <option value="ChenYuluoyan-Thin-Monospaced">é™³é›¨éœ²åœ“é«”ç´°ç­‰å¯¬</option>
          <option value="cwtexq-fangsong">å…¨å­—åº«ä»¿å®‹é«”</option>
          <option value="simfang">ä»¿å®‹é«”</option>
          <option value="STFANGSO">è¯æ–‡ä»¿å®‹é«”</option>
          <option value="ToneOZ-Tsuipita-TC">ToneOZ å­—é«”</option>
          <option value="ç‹æ±‰å®—é¡æ¥·ä½“ç¹">ç‹æ¼¢å®—é¡æ¥·é«”ç¹é«”</option>
          <option value="å¾®è»Ÿæ­£é»‘é«”">å¾®è»Ÿæ­£é»‘é«”</option>
          <option value="å¾®è»Ÿæ­£é»‘é«”-Bold">å¾®è»Ÿæ­£é»‘é«”ç²—é«”</option>
          <option value="å¾®è»Ÿæ­£é»‘é«”-Light">å¾®è»Ÿæ­£é»‘é«”ç´°é«”</option>
        </select>
      </label>
      <label>å¤§å° <input id="size" type="number" min="10" max="96" step="1" value="18"> px</label>
      <label>ç²—ç´° <input id="weight" type="number" min="100" max="900" step="100" value="500"></label>
      <label>æ–‡å­—è‰² <input id="text" type="color" value="#111111"></label>
      <label>é‡é»è‰² <input id="accent" type="color" value="#8b5cf6"></label>
      <label>èƒŒæ™¯è‰² <input id="bg" type="text" value="transparent" placeholder="#FFFFFF æˆ– transparent"></label>
      <label>åœ“è§’ <input id="radius" type="number" min="0" max="48" value="12"> px</label>
      <label>è¡Œè· <input id="line" type="number" step="0.05" min="1" max="2.2" value="1.55"></label>
      <div class="spacer"></div>
      <button class="btn" id="copyUrl">è¤‡è£½è¨­å®šé€£çµ</button>
      <button class="btn" id="toggleUi">éš±è—é¢æ¿</button>
    </div>

    <div id="content" class="wrap" contenteditable="true" spellcheck="false">åœ¨é€™è£¡è¼¸å…¥ä½ çš„å…§å®¹ã€‚ä½ å¯ä»¥æŠŠæ•´å€‹é é¢ä»¥ã€ŒåµŒå…¥ã€æ”¾å…¥ Notionï¼Œç•¶ä½œå¯æ›å­—é«”çš„ callout æˆ–æ¨™é¡Œå¡ç‰‡ä½¿ç”¨ã€‚</div>
  </div>

  <script>
    // å·¥å…·ï¼šè®€å–/å¯«å…¥ URL åƒæ•¸
    const $ = (s)=>document.querySelector(s);
    const params = new URLSearchParams(location.search);

    // å€å¡Šæ¸²æŸ“å‡½æ•¸
    function renderBlock(mode, initial=false){
      const c = $('#content');

      // ä¿ç•™æ—¢æœ‰ã€Œç´”æ–‡å­—å…§å®¹ã€ä»¥ä¾¿åˆ‡æ›æ¨¡å¼ä¸éºå¤±ï¼ˆéƒ¨åˆ†æ¨¡å¼æœƒåŒ…è£ï¼‰
      const raw = c.innerText.trim() || (initial ? '' : '');

      // é è¨­ï¼šæ¸…æ‰èˆŠçš„ã€Œcallout/stripã€é¡åˆ¥ï¼Œç”±å„æ¨¡å¼è‡ªè¡Œæ±ºå®š
      c.classList.remove('callout','strip','h1','h2','h3','quote','math');

      // ä¾æ¨¡å¼ç”¢ç”Ÿæ¨¡æ¿
      switch(mode){
        case 'plain': {
          c.innerHTML = `<div class="p" contenteditable="true">${raw || 'åœ¨é€™è£¡è¼¸å…¥æ®µè½æ–‡å­—â€¦'}</div>`;
          break;
        }
        case 'h1': {
          c.classList.add('h1');
          c.innerHTML = `<div contenteditable="true">${raw || 'Heading 1'}</div>`;
          break;
        }
        case 'h2': {
          c.classList.add('h2');
          c.innerHTML = `<div contenteditable="true">${raw || 'Heading 2'}</div>`;
          break;
        }
        case 'h3': {
          c.classList.add('h3');
          c.innerHTML = `<div contenteditable="true">${raw || 'Heading 3'}</div>`;
          break;
        }
        case 'quote': {
          c.classList.add('quote');
          c.innerHTML = `<div contenteditable="true">${raw || 'å¼•è¨€æ–‡å­—â€¦'}</div>`;
          break;
        }
        case 'bulleted': {
          c.innerHTML = `<ul class="ul" contenteditable="true">
            <li>${raw || 'é …ç›®ä¸€'}</li>
            <li>é …ç›®äºŒ</li>
            <li>é …ç›®ä¸‰</li>
          </ul>`;
          // æ·»åŠ éµç›¤äº‹ä»¶æ”¯æ´
          setupListKeyboardEvents(c);
          break;
        }
        case 'numbered': {
          c.innerHTML = `<ol class="ol" contenteditable="true">
            <li>${raw || 'æ­¥é©Ÿä¸€'}</li>
            <li>æ­¥é©ŸäºŒ</li>
            <li>æ­¥é©Ÿä¸‰</li>
          </ol>`;
          // æ·»åŠ éµç›¤äº‹ä»¶æ”¯æ´
          setupListKeyboardEvents(c);
          break;
        }
        case 'todo': {
          c.innerHTML = `<div class="todo" contenteditable="false">
            ${['å¾…è¾¦äº‹é …ä¸€','å¾…è¾¦äº‹é …äºŒ','å¾…è¾¦äº‹é …ä¸‰'].map((t,i)=>`
              <div class="todo-item" data-i="${i}">
                <input type="checkbox"/>
                <div class="todo-text" contenteditable="true">${i===0 && raw ? raw : t}</div>
              </div>`).join('')}
          </div>`;
          // é» checkbox åŠ ä¸Š done æ¨£å¼
          c.querySelectorAll('.todo-item input[type="checkbox"]').forEach(chk=>{
            chk.addEventListener('change', e=>{
              const item = e.target.closest('.todo-item');
              item.classList.toggle('done', e.target.checked);
              tickResize();
            });
          });
          // æ·»åŠ éµç›¤äº‹ä»¶æ”¯æ´
          setupTodoKeyboardEvents(c);
          break;
        }
        case 'toggle': {
          c.innerHTML = `<details class="toggle">
            <summary contenteditable="true">${raw || 'é»æ“Šå±•é–‹ï¼æ”¶åˆæ¨™é¡Œ'}</summary>
            <div class="toggle-body" contenteditable="true">åœ¨é€™è£¡è¼¸å…¥å±•é–‹å…§å®¹â€¦</div>
          </details>`;
          break;
        }
        case 'code': {
          c.innerHTML = `<pre class="codewrap"><code contenteditable="true">${raw || 'console.log("Hello Notion Widget");'}</code></pre>`;
          break;
        }
        case 'math': {
          c.classList.add('math');
          // ä»¥ KaTeX é¡¯ç¤ºï¼›è‹¥æ²’è¼‰å…¥ KaTeX å‰‡é€€å›ç´”æ–‡å­—
          const expr = raw || String.raw`E = mc^2`;
          if (window.katex) {
            c.innerHTML = `
              <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                <div id="mathbox"></div>
                <button class="btn" style="font-size: 12px; padding: 4px 8px;" onclick="reRenderMath()">é‡æ–°æ¸²æŸ“</button>
              </div>`;
            try {
              katex.render(expr, $('#mathbox'), { throwOnError:false, displayMode:true });
            } catch (e) {
              // å¦‚æœ KaTeX æ¸²æŸ“å¤±æ•—ï¼Œé€€å›ç´”æ–‡å­—
              c.innerHTML = `<div contenteditable="true">$$ ${expr} $$</div>`;
            }
          } else {
            c.innerHTML = `<div contenteditable="true">$$ ${expr} $$</div>`;
          }
          break;
        }
        case 'callout': {
          c.classList.add('callout');
          c.innerHTML = `<div contenteditable="true">${raw || 'é€™æ˜¯ Callout å…§å®¹â€¦'}</div>`;
          break;
        }
        case 'strip': {
          c.classList.add('strip');
          c.innerHTML = `<div contenteditable="true">${raw || 'é€™æ˜¯å·¦å´é‡é»æ¢æ¨£å¼â€¦'}</div>`;
          break;
        }
        default: {
          // å›é€€ Paragraph
          c.innerHTML = `<div class="p" contenteditable="true">${raw || 'åœ¨é€™è£¡è¼¸å…¥æ®µè½æ–‡å­—â€¦'}</div>`;
        }
      }

      tickResize();
      syncUrl(); // è®“ç¶²å€ä¿æŒæœ€æ–°ï¼ˆä»æ²¿ç”¨ä½ åŸæœ¬çš„åƒæ•¸ç­–ç•¥ï¼‰
    }

    // åˆ—è¡¨éµç›¤äº‹ä»¶æ”¯æ´
    function setupListKeyboardEvents(container) {
      container.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const newLi = document.createElement('li');
          newLi.textContent = '';
          container.appendChild(newLi);
          newLi.focus();
          // å°‡æ¸¸æ¨™ç§»åˆ°æ–°é …ç›®å…§
          const range = document.createRange();
          const sel = window.getSelection();
          range.setStart(newLi, 0);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });
    }

    // å¾…è¾¦äº‹é …éµç›¤äº‹ä»¶æ”¯æ´
    function setupTodoKeyboardEvents(container) {
      container.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const todoContainer = container.querySelector('.todo');
          const newTodoItem = document.createElement('div');
          newTodoItem.className = 'todo-item';
          newTodoItem.innerHTML = `
            <input type="checkbox"/>
            <div class="todo-text" contenteditable="true">æ–°å¾…è¾¦äº‹é …</div>
          `;
          
          // æ·»åŠ  checkbox äº‹ä»¶
          const checkbox = newTodoItem.querySelector('input[type="checkbox"]');
          checkbox.addEventListener('change', function(e) {
            const item = e.target.closest('.todo-item');
            item.classList.toggle('done', e.target.checked);
            tickResize();
          });
          
          todoContainer.appendChild(newTodoItem);
          
          // èšç„¦åˆ°æ–°é …ç›®
          const todoText = newTodoItem.querySelector('.todo-text');
          todoText.focus();
          // é¸å–æ–‡å­—ä»¥ä¾¿ç·¨è¼¯
          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(todoText);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });
    }

    // é‡æ–°æ¸²æŸ“æ•¸å­¸å…¬å¼
    function reRenderMath() {
      const c = $('#content');
      const mathbox = $('#mathbox');
      if (mathbox && window.katex) {
        const expr = c.innerText.trim() || 'E = mc^2';
        try {
          katex.render(expr, mathbox, { throwOnError:false, displayMode:true });
        } catch (e) {
          console.error('æ•¸å­¸å…¬å¼æ¸²æŸ“å¤±æ•—:', e);
        }
      }
    }

    // Icon Gate åŠŸèƒ½
    function setupIconGate() {
      const gate = $('#gate');
      const editorContainer = $('#editorContainer');
      const iconUrl = params.get('iconUrl') || './assets/Icon/widget_icon.png';
      const gateParam = params.get('gate');
      const title = params.get('title') || 'é»ä¸€ä¸‹é–‹å§‹ç·¨è¼¯';
      
      // è¨­ç½®åœ–ç¤ºå’Œæ¨™é¡Œ
      $('#gateIcon').src = iconUrl;
      $('#gateTitle').textContent = title;
      
      // åœ–ç¤ºè¼‰å…¥æª¢æŸ¥
      const icon = $('#gateIcon');
      icon.addEventListener('load', function() {
        console.log('åœ–ç¤ºè¼‰å…¥æˆåŠŸ:', icon.naturalWidth, 'x', icon.naturalHeight);
      });
      
      icon.addEventListener('error', function() {
        console.error('åœ–ç¤ºè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­åœ–ç¤º');
        // å¦‚æœ PNG è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ SVG
        icon.src = './assets/Icon/widget_icon.svg';
      });
      
      // é è¨­é¡¯ç¤º Icon Gateï¼Œé™¤éæ˜ç¢ºè¨­å®š gate=0
      if (gateParam === '0') {
        gate.classList.add('hidden');
        editorContainer.classList.remove('hidden');
      } else {
        // é è¨­é¡¯ç¤º Icon Gate
        gate.classList.remove('hidden');
        editorContainer.classList.add('hidden');
      }
      
      // é»æ“Š Gate é€²å…¥ç·¨è¼¯å™¨
      gate.addEventListener('click', function() {
        gate.classList.add('hidden');
        editorContainer.classList.remove('hidden');
        tickResize();
      });
    }

    function applyFromParams(){
      const ui = params.get('ui');
      if(ui === '0') {
        $('#controls').classList.add('hidden');
        document.body.classList.add('ui-hidden');
      } else {
        document.body.classList.remove('ui-hidden');
      }

      const font = params.get('font') || getCSS('--font').replace(/^["']|["']$/g,'');
      const size = params.get('size') || '18';
      const weight = params.get('weight') || '500';
      const text = params.get('text') || '#111111';
      const bg = params.get('bg') || 'transparent';
      const radius = params.get('radius') || '12';
      const line = params.get('line') || '1.55';
      const align = params.get('align') || 'left';
      const accent = params.get('accent') || '#8b5cf6';
      const mode = params.get('mode') || 'plain';
      const shadow = params.get('shadow') === '1' ? '0 6px 24px rgba(0,0,0,.08)' : '0 0 0 rgba(0,0,0,0)';
      const textContent = params.get('textContent');
      const icon = params.get('icon') || 'ğŸ’¡';

      setCSS('--font', font);
      setCSS('--size', size+"px");
      setCSS('--weight', weight);
      setCSS('--text', text);
      setCSS('--bg', bg);
      setCSS('--radius', radius+"px");
      setCSS('--line', line);
      setCSS('--align', align);
      setCSS('--accent', accent);
      setCSS('--shadow', shadow);
      document.documentElement.style.setProperty('--icon', `'"${icon}"'`);

      // æ¨¡å¼åˆ‡æ› - ç¾åœ¨ç”± renderBlock è™•ç†
      // åˆå§‹åŒ–æ™‚ä¸ç«‹å³æ¸²æŸ“ï¼Œç­‰æœ€å¾Œçµ±ä¸€è™•ç†

      if(textContent) c.innerText = decodeURIComponent(textContent);

      // å¥—ç”¨åˆ°æ§åˆ¶é¢æ¿åˆå§‹å€¼
      $('#font').value = font;
      $('#size').value = Number(size);
      $('#weight').value = Number(weight);
      $('#text').value = toColor(text);
      $('#bg').value = bg;
      $('#radius').value = Number(radius);
      $('#line').value = Number(line);
      $('#accent').value = toColor(accent);
      $('#mode').value = mode;

      tickResize();
    }

    function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function setCSS(name, value){ document.documentElement.style.setProperty(name, value); }

    function toColor(v){
      // å°‡ä»»ä½•åˆæ³•é¡è‰²è½‰ç‚º hexï¼ˆè‹¥é€æ˜æˆ–é hexï¼Œfallback åŸå­—ä¸²ï¼‰
      if(v === 'transparent') return '#000000';
      const d = document.createElement('div');
      d.style.color = v; document.body.appendChild(d);
      const rgb = getComputedStyle(d).color; d.remove();
      const m = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if(!m) return v; // å¯èƒ½æ˜¯ oklch / lab ç­‰
      const [r,g,b] = m.slice(1).map(Number);
      return '#' + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
    }

    // æ§åˆ¶é¢æ¿äº‹ä»¶
    const map = {
      font: v=> setCSS('--font', v),
      size: v=> setCSS('--size', v+'px'),
      weight: v=> setCSS('--weight', v),
      text: v=> setCSS('--text', v),
      bg: v=> setCSS('--bg', v),
      radius: v=> setCSS('--radius', v+'px'),
      line: v=> setCSS('--line', v),
      accent: v=> setCSS('--accent', v),
      mode: v => renderBlock(v)
    };

    document.addEventListener('input', (e)=>{
      const id = e.target.id; if(!(id in map)) return; map[id](e.target.value); syncUrl(); tickResize();
    });
    function togglePanel(){
      const controls = $('#controls');
      const hidden = controls.classList.toggle('hidden');
      document.body.classList.toggle('ui-hidden', hidden);
      syncUrl();
      tickResize();
    }
    $('#toggleUi').addEventListener('click', togglePanel);
    $('#copyUrl').addEventListener('click', ()=>{ navigator.clipboard.writeText(location.href).then(()=>{ alert('å·²è¤‡è£½é€£çµï¼Œå¯ç›´æ¥åµŒå…¥ Notionï¼'); }); });
    $('#insertExample').addEventListener('click', ()=>{ 
      const currentMode = $('#mode').value;
      renderBlock(currentMode, true);
    });

    function syncUrl(){
      const q = new URLSearchParams();
      q.set('font', $('#font').value);
      q.set('size', $('#size').value);
      q.set('weight', $('#weight').value);
      q.set('text', $('#text').value);
      q.set('bg', $('#bg').value);
      q.set('radius', $('#radius').value);
      q.set('line', $('#line').value);
      q.set('accent', $('#accent').value);
      q.set('mode', $('#mode').value);
      q.set('ui', $('#controls').classList.contains('hidden') ? '0' : '1');
      // ä¹ŸæŠŠç›®å‰æ–‡å­—å­˜åˆ°åƒæ•¸ï¼ˆå¯é¸ï¼‰
      q.set('textContent', encodeURIComponent($('#content').innerText));
      // ä¿ç•™ Icon Gate åƒæ•¸
      ['iconUrl','gate','title'].forEach(k=>{ const v = params.get(k); if(v!==null) q.set(k,v); });
      history.replaceState(null, '', '?' + q.toString());
    }

    // è‡ªå‹•èª¿æ•´é«˜åº¦ï¼ˆå¹«åŠ© Notion çš„ã€ŒResize to fitã€ï¼‰
    let resizeTimer;

    function currentContainer(){
      const gateVisible = !$('#gate').classList.contains('hidden');
      return gateVisible ? $('#gate') : $('#editorContainer');
    }

    function tickResize(){
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>{
        const target = currentContainer();
        const h = Math.max(1, target.scrollHeight);
        document.body.style.height = h + 'px';
        document.documentElement.style.height = h + 'px';
      }, 50);
    }

    // ç›£çœ‹æ•´å€‹ç·¨è¼¯å®¹å™¨ï¼ˆå«å…§å®¹/åˆ‡æ›æ¨¡å¼ï¼‰
    const obs = new MutationObserver(tickResize);
    obs.observe($('#editorContainer'), {childList:true, subtree:true, characterData:true});
    window.addEventListener('resize', tickResize);

    // åˆå§‹åŒ–
    setupIconGate();
    applyFromParams();
    
    // ä¾åƒæ•¸æ¸²æŸ“åˆå§‹å€å¡Š
    const initialMode = params.get('mode') || 'plain';
    renderBlock(initialMode, true);
    
    tickResize();

    // å¿«æ·éµï¼šShift + P åˆ‡æ›é¢æ¿ï¼›Ctrl/âŒ˜ + Shift + 0 å¼·åˆ¶é¡¯ç¤º
    document.addEventListener('keydown', (e)=>{
      const key = (e.key || '').toLowerCase();
      const mod = e.ctrlKey || e.metaKey;
      if (e.shiftKey && key === 'p' && !mod) {
        e.preventDefault();
        togglePanel();
      }
      if (mod && e.shiftKey && key === '0') {
        e.preventDefault();
        if ($('#controls').classList.contains('hidden')) togglePanel();
      }
    });
  </script>
</body>
</html>
